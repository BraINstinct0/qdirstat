#/bin/sh
#
# Create a complete file list for all installed packages
# dpkg version
#
# Author:  Stefan Hundhammer <Stefan.Hundhammer@gmx.de>
# License: GPL V2

TMPDIR=/tmp
PKGLIST=$TMPDIR/pkglist.txt
FILELIST_RAW=$TMPDIR/filelist-raw.txt
FILELIST=$TMPDIR/filelist.txt
REGEXP_LIST=$TMPDIR/regexp.txt


create_pkglist()
{
    dpkg-query --show --showformat '${Package}:${Architecture}\n' >$PKGLIST
}


add_filelist()
{
    pkg=$1
    echo "Reading file list for $pkg"
    dpkg --listfiles $pkg >>$FILELIST_RAW
}


get_complete_filelist()
{
    rm -f $FILELIST_RAW
    rm -f $FILELIST

    for pkg in $(sort $PKGLIST); do
        add_filelist $pkg
    done
}


filter_filelist()
{
    echo -n "Filtering file list... "
    sed -e 's/^diverted by.*to: //' <$FILELIST_RAW  | \
    grep -v '^/\.$'                                 | \
    sort -u >$FILELIST
    echo " done"
}


create_pkglist
get_complete_filelist
filter_filelist
