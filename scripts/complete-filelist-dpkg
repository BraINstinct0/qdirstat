#/bin/sh
#
# Create a complete file list for all installed packages
# dpkg version
#
# Author:  Stefan Hundhammer <Stefan.Hundhammer@gmx.de>
# License: GPL V2

TMPDIR=/tmp
PKGLIST=$TMPDIR/pkglist.txt
FILELIST_RAW=$TMPDIR/filelist-raw.txt
FILELIST=$TMPDIR/filelist.txt
REGEXP_LIST=$TMPDIR/regexp.txt


create_pkglist()
{
    dpkg-query --show --showformat '${Package}:${Architecture}\n' >$PKGLIST
}


add_filelist()
{
    pkg=$1
    echo "Reading file list for $pkg"
    dpkg --listfiles $pkg >>$FILELIST_RAW
}


get_complete_filelist()
{
    rm -f $FILELIST_RAW
    rm -f $FILELIST

    for pkg in $(sort $PKGLIST); do
        add_filelist $pkg
    done
}


filter_filelist()
{
    echo -n "Filtering file list... "
    sed -e 's/^diverted by.*to: //' <$FILELIST_RAW  | \
    grep -v '^/\.$'                                 | \
    sort -u >$FILELIST
    echo " done"
}


# Change each line of the file list to a line that matches a file (not a
# directory!) entry in a QDirStat cache file.
#
# We don't want to match directories here because they might not be empty even
# after disregarding all packaged files in them. So we use a file entry ('F')
# for the regexp in each case; if it's a directory, it simply won't match
# against the entry in the cache file.
#
# Sample cache file entries:
#
# F /bin/bash	1113504	0x5ac519c2
# D /usr/include	12288	0x5caa0bed
#
create_regexp_list()
{
    echo -n "Creating regexps..."
    
    # Need to escape a literal [ for the alias for /usr/bin/test and its man page.
    # Notice that egrep does not understand \d for digits.
    sed \
        -e 's:\[:\\[:'          \
        -e 's:^/:^F\\s+/:'      \
        -e 's:$:\\s+[0-9]+.*:'    \
        <$FILELIST >$REGEXP_LIST
    echo " done"
}


create_pkglist
get_complete_filelist
filter_filelist
# create_regexp_list
